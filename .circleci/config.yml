version: 2.1

commands:
   # Exercise - Rollback
   destroy_environment:
     steps:
       - run:
           name: Destroy environment
           # ${CIRCLE_WORKFLOW_ID} is a Built-in environment variable 
           # ${CIRCLE_WORKFLOW_ID:0:5} takes the first 5 chars of the variable CIRCLE_CI_WORKFLOW_ID 
           when: on_fail
           command: |
             aws cloudformation delete-stack --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:7}

jobs:
  start-job:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Ansible Step"
          command: "echo Start the job!"

  create_infrastructure: 
    docker:
      - image: amazon/aws-cli
    steps:
      - checkout
      - run:
          name: Create Cloudformation Stack
          command: |
            aws cloudformation deploy \
              --template-file CloudFormation/template.yml \
              --stack-name myStack-${CIRCLE_WORKFLOW_ID:0:5} \
              --region us-east-1

smoke_test:
 docker:
   - image: alpine:latest
 steps:
   - run:
       name: Test job
       # Fail the job intentionally to simulate an error.
       command:  return 1
   - destroy_environment  

  configure_infrastructure: 
    docker:
      - image: cimg/python:3.11.0
    steps:
      - checkout
      - add_ssh_keys:            
          fingerprints: ["62:49:77:c5:92:71:3c:43:cf:88:19:d7:0d:4e:de:a5"] 
      - run:
          name: Install Ansible
          command: |
            sudo apt --purge autoremove
            sudo apt update
            sudo apt install ansible
      - run:
          name: Run Playbook and Configure server
          command: |
            mkdir -p ~/.ssh            
            echo "3.223.125.8 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDkyYKR/4wgVeWtPY8PJPxfYaY16T3bdEsb1tDKo24Slg7wNCmZGcCsntUJeBS5Fk/y7QI6Ro/o8pJO4DXlnX/3zyfZi79uJMV+n3Kjq7zDAzjW9UCJa+wZ0ze/QapR/ceqD8nSTq7h+ov2p10SRBNmO0CdAvsxlaGa3ZuzrX7JBbXCT3sXk8ISQZzLKdWadjFf4/WbpiQ+xv4BIIrJFDT1eI3mRnK7DAKQwNsoM9e+C3WEd/WASKnf7kvJuc3MgDkGPM8nRmARB4Gi6iGdBe7LE6LrnJI5rgUrGOtIUbShRNNrFZsHDa/1PgvQmQok28FfQiYenTsr0Ot0r48P0weiPYJVdp1nu0HAlNqKth20QT7fvGkZhbLdGh4lT5iEZzoM2lhFMzGpy6NOgwtNpdTP0HLDva9YzddjS3Z9KhMEBjMSoL2HD5uj9DGUx6feaw7TmoMD890H72PDLeRMiBAtny51eix0gdwxWh11H4bYwra9uDP1vVmnHKfOtJ21+DM=" >> ~/.ssh/known_hosts
            ansible-playbook AnsibleConfig/main.yml -i AnsibleConfig/inventory.txt
workflows:
  ansible-workflow: 
    jobs:
      - start-job
      - create_infrastructure
      - smoke_test
      # - configure_infrastructure
      # - configure_infrastructure:
      #     requires:
      #       - create_infrastructure

